name: Run Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Run V2 feature tests
      run: |
        echo "ðŸ§ª Running V2 Feature Tests..."
        python test_v2_features.py
      continue-on-error: false

    - name: Run V1 core tests
      run: |
        echo "ðŸ§ª Running V1 Core Tests..."
        python test_all.py
      continue-on-error: false
      env:
        USE_LLM: false
        DATABASE_PATH: data/test_ci.db

    - name: Test custom food SQLite storage
      run: |
        echo "ðŸ§ª Testing Custom Food SQLite Storage..."
        python test_custom_food_sqlite.py
      continue-on-error: false

    - name: Test Summary
      if: always()
      run: |
        echo "=========================================="
        echo "ðŸ“Š Test Execution Complete"
        echo "=========================================="
        echo "V2 Tests: 12 tests"
        echo "V1 Tests: 9 tests"
        echo "Custom Food Tests: 6 checks"
        echo "Total: 21+ tests"

    - name: Upload test artifacts
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: test-failures
        path: |
          data/*.db
          *.log
